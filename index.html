<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Fun√ß√£o da Moeda - Dashboard Automotivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
        }

        /* Regras de Impress√£o */
        @media print {
            @page {
                size: landscape;
                margin: 15mm;
            }

            body {
                background: #ffffff !important;
                color: #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .no-print {
                display: none !important;
            }

            .glass-panel {
                background: #f8fafc !important;
                border: 2px solid #cbd5e1 !important;
                box-shadow: none !important;
                border-radius: 8px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                margin-bottom: 20px !important;
                color: #000000 !important;
            }

            .grid {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 15px !important;
            }

            .md\:grid-cols-3>div {
                width: calc(33.333% - 10px) !important;
                flex: 1 1 auto;
            }

            .lg\:col-span-3 {
                width: 68% !important;
            }

            .lg\:grid-cols-4>div:last-child {
                width: 30% !important;
            }

            canvas {
                min-height: 250px !important;
                max-height: 300px !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            h1,
            h2,
            h3,
            p,
            span,
            td,
            th,
            label {
                color: #0f172a !important;
            }

            .text-emerald-400 {
                color: #059669 !important;
                font-weight: 800 !important;
            }

            .text-rose-400 {
                color: #e11d48 !important;
                font-weight: 800 !important;
            }

            .text-amber-400 {
                color: #d97706 !important;
                font-weight: 800 !important;
            }

            .text-blue-400 {
                color: #2563eb !important;
                font-weight: 800 !important;
            }

            select {
                border: none !important;
                appearance: none;
                background: transparent !important;
                color: #0f172a !important;
                font-weight: bold;
                padding: 0 !important;
            }

            table,
            th,
            td {
                border-color: #cbd5e1 !important;
            }
        }
    </style>
</head>

<body class="p-6 md:p-12">

    <div class="no-print flex justify-end mb-6">
        <button onclick="window.print()"
            class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-colors flex items-center gap-2">
            Exportar Relat√≥rio (PDF)
        </button>
    </div>

    <header class="mb-10 text-center">
        <h1 class="text-4xl font-bold text-emerald-400 mb-2">A Fun√ß√£o da Moeda</h1>
        <p class="text-slate-400 italic font-semibold">"O segundo atual e o segundo seguinte. Deixando o dinheiro no
            lugar dele."</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="glass-panel p-6 text-center w-full hover:border-rose-500/50 transition-colors">
            <h3 class="text-lg text-slate-300 font-bold tracking-wider uppercase text-xs">Custo Anual (Ve√≠culo)</h3>
            <p class="text-3xl font-bold text-rose-400 mt-2" id="painel_custo_anual">R$ 0,00</p>
        </div>
        <div class="glass-panel p-6 text-center w-full hover:border-amber-500/50 transition-colors">
            <h3 class="text-lg text-slate-300 font-bold tracking-wider uppercase text-xs">Meta Semanal</h3>
            <p class="text-3xl font-bold text-amber-400 mt-2" id="painel_meta_semanal">R$ 0,00</p>
        </div>
        <div class="glass-panel p-6 text-center w-full hover:border-emerald-500/50 transition-colors">
            <h3 class="text-lg text-slate-300 font-bold tracking-wider uppercase text-xs">Meta Di√°ria</h3>
            <p class="text-3xl font-bold text-emerald-400 mt-2" id="painel_meta_diaria">R$ 0,00</p>
        </div>
    </div>

    <div class="glass-panel p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Fluxo Di√°rio e Din√¢mica</h2>
            <div class="flex gap-3 mt-4 md:mt-0">
                <select id="filtro-ano" onchange="atualizarDashboard()"
                    class="bg-slate-800 text-emerald-400 p-2 rounded border border-slate-600 outline-none font-bold"></select>
                <select id="filtro-mes" onchange="atualizarDashboard()"
                    class="bg-slate-800 text-emerald-400 p-2 rounded border border-slate-600 outline-none font-bold"></select>
            </div>
        </div>
        <div class="relative h-[400px] w-full">
            <canvas id="pagamentosChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

        <div class="glass-panel p-6 flex flex-col justify-between hover:border-emerald-500/50 transition-colors">
            <h3
                class="text-emerald-500 font-bold uppercase tracking-widest text-sm mb-4 border-b border-emerald-500/30 pb-2">
                M√©tricas do M√™s</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-[11px] text-slate-400 uppercase font-bold">Bruto Mensal</p>
                    <p class="text-3xl font-bold text-emerald-400" id="m_bruto_mensal">R$ 0,00</p>
                </div>
                <div>
                    <p class="text-[11px] text-slate-400 uppercase font-bold">Bruto √öltima Semana</p>
                    <p class="text-xl font-bold text-emerald-400/80" id="m_bruto_semanal">R$ 0,00</p>
                </div>
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-slate-700/50">
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase font-bold">M√©dia Semanal</p>
                        <p class="text-lg font-bold text-slate-200" id="m_media_semanal">R$ 0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase font-bold">M√©dia Di√°ria</p>
                        <p class="text-lg font-bold text-slate-200" id="m_media_diaria">R$ 0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel p-6 flex flex-col justify-between hover:border-blue-500/50 transition-colors">
            <h3 class="text-blue-500 font-bold uppercase tracking-widest text-sm mb-4 border-b border-blue-500/30 pb-2">
                M√©tricas do Ano</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-[11px] text-slate-400 uppercase font-bold">Bruto Anual</p>
                    <p class="text-3xl font-bold text-blue-400" id="m_bruto_anual">R$ 0,00</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <p class="text-[11px] text-slate-400 uppercase font-bold">M√©dia Mensal</p>
                        <p class="text-xl font-bold text-blue-400/80" id="m_media_mensal_ano">R$ 0</p>
                    </div>
                    <div>
                        <p class="text-[11px] text-slate-400 uppercase font-bold">M√©dia Semanal</p>
                        <p class="text-xl font-bold text-blue-400/80" id="m_media_semanal_ano">R$ 0</p>
                    </div>
                </div>
                <div class="pt-2 border-t border-slate-700/50">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">M√©dia Di√°ria (Ano)</p>
                    <p class="text-lg font-bold text-slate-200" id="m_media_diaria_ano">R$ 0</p>
                </div>
            </div>
        </div>

        <div class="glass-panel p-6 flex flex-col justify-between hover:border-amber-500/50 transition-colors">
            <h3
                class="text-amber-500 font-bold uppercase tracking-widest text-sm mb-4 border-b border-amber-500/30 pb-2">
                Globais (Hist√≥rico)</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-[11px] text-slate-400 uppercase font-bold">Bruto Total de Todos os Tempos</p>
                    <p class="text-3xl font-bold text-amber-400" id="m_bruto_global">R$ 0,00</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <p class="text-[11px] text-slate-400 uppercase font-bold">M√©dia Anual</p>
                        <p class="text-xl font-bold text-amber-400/80" id="m_media_anual_global">R$ 0</p>
                    </div>
                    <div>
                        <p class="text-[11px] text-slate-400 uppercase font-bold">M√©dia Mensal</p>
                        <p class="text-xl font-bold text-amber-400/80" id="m_media_mensal_global">R$ 0</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-slate-700/50">
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase font-bold">M√©dia Semanal</p>
                        <p class="text-lg font-bold text-slate-200" id="m_media_semanal_global">R$ 0</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase font-bold">M√©dia Di√°ria</p>
                        <p class="text-lg font-bold text-slate-200" id="m_media_diaria_global">R$ 0</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="glass-panel p-6 mb-10">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-white">A For√ßa dos Juros Compostos (6 Anos)</h2>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-3">
                <label for="aporteSelect" class="text-slate-300 font-bold">Aporte Mensal:</label>
                <select id="aporteSelect"
                    class="bg-slate-800 text-blue-400 font-bold p-2 rounded border border-slate-600 outline-none"
                    onchange="atualizarGraficoInvestimentos()">
                    <option value="1000">R$ 1.000</option>
                    <option value="1500">R$ 1.500</option>
                    <option value="2000" selected>R$ 2.000</option>
                    <option value="2500">R$ 2.500</option>
                    <option value="3000">R$ 3.000</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-6 text-center border-b border-slate-700 pb-4">
            <div>
                <p class="text-sm text-slate-400 font-bold">Total Depositado (72 meses)</p>
                <p class="text-xl font-bold text-slate-300" id="resumoDepositado">R$ 0,00</p>
            </div>
            <div>
                <p class="text-sm text-slate-400 font-bold">Total de Juros Ganhos</p>
                <p class="text-xl font-bold text-blue-400" id="resumoJuros">R$ 0,00</p>
            </div>
            <div>
                <p class="text-sm text-slate-400 font-bold">Patrim√¥nio Final</p>
                <p class="text-xl font-bold text-emerald-400" id="resumoFinal">R$ 0,00</p>
            </div>
        </div>
        <div class="relative h-80 w-full"><canvas id="investimentosChart"></canvas></div>
    </div>

    <div class="glass-panel p-6">
        <h2 class="text-2xl font-bold text-white mb-2" id="tabelaTitulo">Relat√≥rio de Pagamentos</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse" style="page-break-inside: auto;">
                <thead style="display: table-header-group;">
                    <tr class="border-b border-slate-600 text-slate-400">
                        <th class="p-3 font-bold">Data</th>
                        <th class="p-3 font-bold">Descri√ß√£o</th>
                        <th class="p-3 font-bold">Valor Pago</th>
                        <th class="p-3 font-bold">Meta Di√°ria</th>
                        <th class="p-3 font-bold">Status</th>
                    </tr>
                </thead>
                <tbody id="tabelaPagamentosBody" class="text-slate-300" style="display: table-row-group;"></tbody>
            </table>
        </div>
    </div>

    <div id="chat-widget"
        class="fixed bottom-24 right-4 w-[350px] sm:w-[400px] bg-slate-800 rounded-xl shadow-2xl border border-slate-600 hidden flex-col z-50 no-print transition-all">
        <div class="bg-slate-900 p-4 rounded-t-xl border-b border-slate-700 flex justify-between items-center">
            <h3 class="text-emerald-400 font-bold flex items-center gap-2">ü§ñ Assistente Moeda</h3>
            <button onclick="toggleChat()"
                class="text-slate-400 hover:text-rose-400 text-xl leading-none font-bold">√ó</button>
        </div>

        <div id="chat-messages" class="p-4 h-80 overflow-y-auto flex flex-col gap-4 text-sm scroll-smooth">
            <div
                class="bg-slate-700 p-3 rounded-lg text-slate-200 self-start w-[85%] border border-slate-600 shadow-md">
                Fale agora com o Gemini atrav√©s do motor RAG do nosso projeto. Tire suas d√∫vidas, entenda as m√©tricas ou
                comece a funda√ß√£o do seu pr√≥prio projeto do zero de acordo com as suas necessidades!
            </div>
        </div>

        <div class="p-3 border-t border-slate-700 bg-slate-900 rounded-b-xl flex gap-2">
            <input type="text" id="chat-input"
                class="flex-1 bg-slate-800 text-white rounded-lg p-3 outline-none border border-slate-600 focus:border-emerald-500 transition-colors"
                placeholder="Pergunte algo ao projeto..." onkeypress="if(event.key === 'Enter') enviarMensagem()">
            <button id="btn-enviar" onclick="enviarMensagem()"
                class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold transition-colors shadow-md">Enviar</button>
        </div>
    </div>

    <button onclick="toggleChat()"
        class="fixed bottom-6 right-6 bg-emerald-600 hover:bg-emerald-500 text-white p-4 rounded-full shadow-[0_0_15px_rgba(16,185,129,0.5)] z-40 no-print transition-transform hover:scale-110 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z" />
        </svg>
    </button>

    <script>
        const formatarMoeda = (valor) => valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const corTextoGrafico = '#64748b';


        let db = null;
        let pagamentosChart = null;
        let investimentosChart = null;
        let servidorAcordado = false;

        // 1. CARREGAR OS DADOS DO JSON
        async function iniciarSistema() {
            try {
                const response = await fetch('cofre_processado.json');
                db = await response.json();

                popularFiltros();
                atualizarDashboard();
            } catch (error) {
                console.error("Erro na investiga√ß√£o:", error);
                alert("üïµÔ∏è Sherlock: N√£o consegui encontrar o arquivo JSON! Se a tela ficar vazia, abra este projeto usando o Live Server do Antigravity/VSCode.");
            }
        }

        function popularFiltros() {
            const anoSelect = document.getElementById('filtro-ano');
            const mesSelect = document.getElementById('filtro-mes');
            anoSelect.innerHTML = '';
            mesSelect.innerHTML = '';

            // Puxa os anos
            const anos = Object.keys(db.anos).sort().reverse();
            anos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                anoSelect.appendChild(option);
            });

            // Puxa os meses
            const mesesNomes = {
                "01": "Janeiro", "02": "Fevereiro", "03": "Mar√ßo", "04": "Abril",
                "05": "Maio", "06": "Junho", "07": "Julho", "08": "Agosto",
                "09": "Setembro", "10": "Outubro", "11": "Novembro", "12": "Dezembro"
            };

            Object.keys(mesesNomes).forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                option.textContent = mesesNomes[num];
                mesSelect.appendChild(option);
            });

            // Seleciona a √∫ltima data dispon√≠vel
            const chavesMeses = Object.keys(db.meses).sort().reverse();
            if (chavesMeses.length > 0) {
                const ultimoAnoMes = chavesMeses[0];
                anoSelect.value = ultimoAnoMes.substring(0, 4);
                mesSelect.value = ultimoAnoMes.substring(5, 7);
            }
        }

        // 2. A M√ÅGICA DE ATUALIZAR TUDO NA TELA
        function atualizarDashboard() {
            if (!db) return;

            const anoSelecionado = document.getElementById('filtro-ano').value;
            const mesSelecionado = document.getElementById('filtro-mes').value;
            const chaveMesSelecionado = `${anoSelecionado}-${mesSelecionado}`;

            // Dados ou Fallback (Zera a tela se o m√™s n√£o tiver corrida)
            const dadosMes = db.meses[chaveMesSelecionado] || { bruto_mensal: 0, bruto_ultima_semana: 0, media_diaria_mes: 0, media_semanal_mes: 0, pagamentos_diarios: {} };
            const dadosAno = db.anos[anoSelecionado] || { bruto_anual: 0, media_mensal_anual: 0, media_semanal_anual: 0 };
            const dadosGeral = db.geral;

            // PREENCHER OS 3 PAIN√âIS DO TOPO COM OS DADOS DIN√ÇMICOS DO PYTHON
            document.getElementById('painel_custo_anual').innerText = formatarMoeda(dadosGeral.custo_anual_veiculo);
            document.getElementById('painel_meta_semanal').innerText = formatarMoeda(dadosGeral.meta_semanal);
            document.getElementById('painel_meta_diaria').innerText = formatarMoeda(dadosGeral.meta_diaria);

            // Define a nova linha vermelha tracejada do gr√°fico baseada na meta do Python
            const despesaDiaria = dadosGeral.meta_diaria;

            // PREENCHER COLUNA 1: M√äS
            document.getElementById('m_bruto_mensal').innerText = formatarMoeda(dadosMes.bruto_mensal);
            document.getElementById('m_bruto_semanal').innerText = formatarMoeda(dadosMes.bruto_ultima_semana);
            document.getElementById('m_media_diaria').innerText = formatarMoeda(dadosMes.media_diaria_mes);
            document.getElementById('m_media_semanal').innerText = formatarMoeda(dadosMes.media_semanal_mes);

            // PREENCHER COLUNA 2: ANO (Com nova m√©dia di√°ria)
            document.getElementById('m_bruto_anual').innerText = formatarMoeda(dadosAno.bruto_anual);
            document.getElementById('m_media_mensal_ano').innerText = formatarMoeda(dadosAno.media_mensal_anual);
            document.getElementById('m_media_semanal_ano').innerText = formatarMoeda(dadosAno.media_semanal_anual);
            document.getElementById('m_media_diaria_ano').innerText = formatarMoeda(dadosAno.media_diaria_anual || 0); // O || 0 evita erro se n√£o houver dado

            // PREENCHER COLUNA 3: GLOBAL (Com novas m√©dias semanal e di√°ria)
            document.getElementById('m_bruto_global').innerText = formatarMoeda(dadosGeral.bruto_total);
            document.getElementById('m_media_anual_global').innerText = formatarMoeda(dadosGeral.media_anual_global);
            document.getElementById('m_media_mensal_global').innerText = formatarMoeda(dadosGeral.media_mensal_global);
            document.getElementById('m_media_semanal_global').innerText = formatarMoeda(dadosGeral.media_semanal_global || 0);
            document.getElementById('m_media_diaria_global').innerText = formatarMoeda(dadosGeral.media_diaria_global || 0);

            // Gr√°fico de Pagamentos
            document.getElementById('tabelaTitulo').innerText = `Relat√≥rio de Pagamentos - ${chaveMesSelecionado}`;

            const dataObjeto = new Date(anoSelecionado, parseInt(mesSelecionado), 0);
            const totalDiasMes = dataObjeto.getDate();

            const labelsDias = [];
            const dadosValores = [];
            const linhaMeta = [];

            const tbody = document.getElementById('tabelaPagamentosBody');
            tbody.innerHTML = '';

            for (let dia = 1; dia <= totalDiasMes; dia++) {
                const diaStr = String(dia).padStart(2, '0');
                const dataChave = `${chaveMesSelecionado}-${diaStr}`;

                const valorDia = dadosMes.pagamentos_diarios[dataChave] || 0;

                labelsDias.push([`Dia ${dia}`, valorDia > 0 ? formatarMoeda(valorDia) : '-']);
                dadosValores.push(valorDia);
                linhaMeta.push(despesaDiaria);

                if (valorDia > 0) {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-700/50";
                    const statusHtml = valorDia >= despesaDiaria
                        ? `<span class="text-emerald-500 font-bold uppercase text-[10px]">Meta Batida</span>`
                        : `<span class="text-rose-500 font-bold uppercase text-[10px]">Abaixo</span>`;
                    tr.innerHTML = `
                        <td class="p-3 font-bold">${diaStr}/${mesSelecionado}/${anoSelecionado}</td>
                        <td class="p-3">Servi√ßo/Repasse</td>
                        <td class="p-3 text-emerald-500 font-bold">${formatarMoeda(valorDia)}</td>
                        <td class="p-3 font-medium">${formatarMoeda(despesaDiaria)}</td>
                        <td class="p-3">${statusHtml}</td>`;
                    tbody.appendChild(tr);
                }
            }

            const ctx = document.getElementById('pagamentosChart').getContext('2d');
            if (pagamentosChart) pagamentosChart.destroy();

            pagamentosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labelsDias,
                    datasets: [
                        { label: 'Recebido no Dia', data: dadosValores, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', borderWidth: 3, tension: 0.4, fill: true, pointBackgroundColor: '#10b981', pointRadius: 3 },
                        { label: 'Meta Di√°ria (Despesa)', data: linhaMeta, borderColor: '#e11d48', borderWidth: 2, borderDash: [5, 5], tension: 0, pointRadius: 0, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { labels: { color: corTextoGrafico, font: { weight: 'bold' } } } },
                    scales: {
                        x: { ticks: { color: corTextoGrafico, font: { size: 10, weight: 'bold' } }, grid: { color: 'rgba(100,116,139,0.1)' } },
                        y: { ticks: { color: corTextoGrafico, font: { weight: 'bold' } }, grid: { color: 'rgba(100,116,139,0.1)' }, min: 0 }
                    }
                }
            });
        }

        // 3. GR√ÅFICO DE INVESTIMENTOS
        function atualizarGraficoInvestimentos() {
            const aporte = parseFloat(document.getElementById('aporteSelect').value);
            const meses = 72;
            const taxa = 0.0083;

            let labelsMeses = [];
            let dadosAporteMensal = [];
            let dadosRendimentoDoMes = [];
            let montanteTotal = 0;
            let totalDepositado = 0;

            for (let i = 1; i <= meses; i++) {
                labelsMeses.push(`M√™s ${i}`);
                totalDepositado += aporte;
                montanteTotal += aporte;

                let rendimentoNesteMes = montanteTotal * taxa;
                montanteTotal += rendimentoNesteMes;

                dadosAporteMensal.push(aporte);
                dadosRendimentoDoMes.push(rendimentoNesteMes);
            }

            document.getElementById('resumoDepositado').innerText = formatarMoeda(totalDepositado);
            document.getElementById('resumoJuros').innerText = formatarMoeda(montanteTotal - totalDepositado);
            document.getElementById('resumoFinal').innerText = formatarMoeda(montanteTotal);

            const ctxInvestimentos = document.getElementById('investimentosChart').getContext('2d');
            if (investimentosChart) investimentosChart.destroy();

            investimentosChart = new Chart(ctxInvestimentos, {
                type: 'line',
                data: {
                    labels: labelsMeses,
                    datasets: [
                        { label: 'Dep√≥sito Mensal (Esfor√ßo)', data: dadosAporteMensal, borderColor: '#64748b', borderWidth: 2, borderDash: [5, 5], tension: 0, fill: false, pointRadius: 0 },
                        { label: 'Rendimento NO M√äS', data: dadosRendimentoDoMes, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.2)', borderWidth: 3, tension: 0.4, fill: true, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: corTextoGrafico, font: { weight: 'bold' } } } },
                    scales: {
                        x: { ticks: { color: corTextoGrafico, font: { weight: 'bold' } }, grid: { display: false } },
                        y: { ticks: { color: corTextoGrafico, font: { weight: 'bold' } }, grid: { color: 'rgba(100,116,139,0.1)' } }
                    }
                }
            });
        }

        // --- L√ìGICA DO CHAT (MOTOR RAG) ---
        function toggleChat() {
            const chat = document.getElementById('chat-widget');
            chat.classList.toggle('hidden');
            chat.classList.toggle('flex');
            if (!chat.classList.contains('hidden')) {
                document.getElementById('chat-input').focus();
            }
        }

        async function enviarMensagem() {
            const input = document.getElementById('chat-input');
            const mensagem = input.value.trim();
            const btn = document.getElementById('btn-enviar');

            if (!mensagem) return;

            let contagem = parseInt(localStorage.getItem('limite_rag_moeda') || '0');
            if (contagem >= 10) {
                adicionarBalao("‚ö†Ô∏è Voc√™ atingiu o limite de 10 intera√ß√µes di√°rias de teste neste painel. Retorne amanh√£ ou clone o projeto para usar sem limites!", 'bot');
                input.disabled = true;
                btn.disabled = true;
                return;
            }

            adicionarBalao(mensagem, 'user');
            input.value = '';
            input.disabled = true;
            btn.disabled = true;

            localStorage.setItem('limite_rag_moeda', contagem + 1);

            // --- A M√ÅGICA DO DESPERTADOR (WAKE-UP CALL) ---
            if (!servidorAcordado) {
                const idDespertador = "msg-despertador-" + Date.now();
                adicionarBalao("‚è≥ Ol√°! Como uso um servidor gratuito, estou ligando os motores da IA. Isso leva cerca de 40 a 50 segundos na primeira vez do dia. S√≥ um momento...", 'bot', idDespertador);

                try {
                    // Bate na porta do Render s√≥ para acordar a m√°quina (n√£o aciona o Gemini)
                    await fetch('https://api-assistente-moeda.onrender.com/ping');
                    servidorAcordado = true; // A m√°quina acordou!
                    document.getElementById(idDespertador).remove(); // Tira a mensagem de espera
                } catch (e) {
                    document.getElementById(idDespertador).remove();
                    adicionarBalao("üö® Falha ao acordar o servidor. Verifique a conex√£o.", 'bot');
                    input.disabled = false;
                    btn.disabled = false;
                    input.focus();
                    return;
                }
            }
            // ----------------------------------------------

            const idPensando = "msg-" + Date.now();
            adicionarBalao("Analisando os dados e a filosofia do projeto...", 'bot', idPensando);

            const anoAtual = document.getElementById('filtro-ano').value;
            const mesAtual = document.getElementById('filtro-mes').value;
            const contextoInvisivel = `O usu√°rio est√° visualizando a tela filtrada para o Ano: ${anoAtual} e M√™s: ${mesAtual}. Se a pergunta for sobre m√©tricas ou o melhor/pior dia, baseie-se preferencialmente neste per√≠odo espec√≠fico do JSON.`;

            try {
                const resposta = await fetch('https://api-assistente-moeda.onrender.com/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mensagem: mensagem,
                        contexto_tela: contextoInvisivel
                    })
                });

                const dados = await resposta.json();
                document.getElementById(idPensando).remove();

                if (dados.erro) {
                    adicionarBalao("Erro no servidor: " + dados.erro, 'bot');
                } else {
                    const textoFormatado = dados.resposta.replace(/\n/g, '<br>');
                    adicionarBalao(textoFormatado, 'bot');
                }

            } catch (erro) {
                document.getElementById(idPensando).remove();
                adicionarBalao("üö® Sem conex√£o com a Matriz.", 'bot');
            }

            input.disabled = false;
            btn.disabled = false;
            input.focus();
        }

        function adicionarBalao(texto, remetente, id = null) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            if (id) div.id = id;

            if (remetente === 'user') {
                div.className = "bg-blue-600 p-3 rounded-lg text-white self-end w-[85%] shadow-md border border-blue-500";
            } else {
                div.className = "bg-slate-700 p-3 rounded-lg text-slate-200 self-start w-[85%] shadow-md border border-slate-600";
            }

            div.innerHTML = texto;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // INICIALIZA O SISTEMA
        atualizarGraficoInvestimentos();
        iniciarSistema();
    </script>
</body>

</html>